# 產品規格書(Spec)

# 產品規格書(Spec)：繁星推薦線上志願選填系統

## 1. 專案概述

本專案旨在將原先的「Star115 繁星推薦自動判定系統」之邏輯與資料，無縫升級並整合至基於 Vue3 + GAS (vue3-gas) 的現代化網頁框架中。系統提供符合繁星推薦資格的高中學生登入，檢視專屬的可選填校系，並完成志願的搜尋、新增、排序與儲存。最終產出標準化 PDF 文件，供後續實體撕榜作業使用。

**專案目標與價值**

- **無紙化與自動化**：全面取代傳統紙本與繁瑣的 Excel 人工填寫流程。
- **使用者體驗升級**：提供直覺的按鈕排序（上/下移動）、多關鍵字秒搜體驗，降低填寫錯誤率。
- **嚴格資格把關**：透過前端防呆與替換邏輯，確保學生只能填寫符合自身成績檢定標準的校系，且符合「同一大學同一學群限填一科系」之核心業務規則。

---

## 2. 系統架構與資料環境

本系統採用前後端分離架構，以 Google 生態系作為無伺服器（Serverless）的後端與資料庫解決方案。

| **模組類別**               | **技術選型與規格細節**                                                                                                                                   |
| -------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **前端環境**               | Vue 3 (Composition API)、Vite (建置工具)、Element Plus (UI 組件庫)、Pinia (全域狀態管理)。                                                               |
| **後端環境**               | Google Apps Script (GAS)。                                                                                                                               |
| **通訊機制**               | 全面棄用傳統 Web API (如 axios)，一律透過前端 `gas-service.js` 封裝的 `google.script.run` 進行非同步資料交換，確保與 Google 生態系的無縫授權與連線安全。 |
| **資料庫 (Google Sheets)** | `users` 表：儲存學生學號與登入密碼。                                                                                                                     |

`撕榜前志願表` 表：儲存學生最終確認的 20 個志願完整代碼。
`setup` 表：系統全域參數設定（包含「撕榜前/後」狀態切換，以及「YYYY/MM/DD HH:mm:ss」格式的開放區間）。 |
| **儲存空間 (Google Drive)** | 存放系統預先生成之學生專屬 JSON 檔案（內含可選填校系清單）。
存放系統最終生成的 PDF 志願表檔案。 |

---

## 3. 全域狀態與資料預處理 (Pinia)

為了確保跨頁面的資料一致性與前端搜尋效能，系統在學生登入階段需完成高度整合的資料初始化。

### 登入初始化與 Payload 結構

學生登入成功後，GAS 的 `login` API 必須一次性回傳所有必要資訊，存入 Pinia Store。包含：

- **全域設定 (`setup`)**：當前系統開放狀態與時間範圍。
- **專屬校系資料 (`studentJSON`)**：從 Drive 讀取的學生個人可選填校系原始資料。
- **已選志願清單 (`preferencesList`)**：從「撕榜前志願表」讀取的歷史填寫紀錄。

### 資料扁平化預處理 (Flattening)

取得 `studentJSON` 後，前端需立即將原有的巢狀結構轉換為一維陣列物件，以利後續的清單渲染與高頻率搜尋。每個轉換後的物件必須包含以下明確定義的欄位：

- **基礎欄位**：`學校名稱`、`學校代碼`、`學群名稱`、`學群代碼`、`學系名稱`、`學系代碼`。
- **完整代碼**：格式為 `學校代碼-學群代碼-學系代碼`（範例：`1-1-101`），作為資料庫儲存與精準比對的唯一鍵值 (Unique Key)。
- **學校學群代碼**：格式為 `學校代碼-學群代碼`（範例：`1-1`），專用於快速檢查同校同學群是否已被選填的防呆依據。
- **搜尋文本**：將所有文字資訊合併為單一字串（範例：`國立臺灣大學 第一類學群 中國文學系`），大幅提升前端字串檢索效能。

### 全域時間卡控機制

前端應用程式需持續（或於路由切換時）比對當前本地時間與 `setup` 取得的開放區間。

- **非開放期間行為**：志願管理相關頁面強制切換為「唯讀模式」。隱藏新增、刪除、上移、下移與儲存按鈕。
- **提示機制**：於畫面頂端醒目處顯示「目前非志願選填開放時間」等提示語。

---

## 4. 核心頁面與功能需求

### 4.1 已選志願管理頁面 (`selected-group`)

此頁面為學生登入後的主控台，用於檢視與管理已選入的志願。

- **顯示邏輯**：登入成功即顯示目前的志願清單，最多允許選填 20 個志願。
- **清單操作**：每個志願項目提供「向上移動 (↑)」、「向下移動 (↓)」與「移除」按鈕。點擊後即時操作前端 Pinia 陣列，不立即觸發後端寫入。
- **儲存機制**：當志願順序或內容有變動時，學生需點擊 [儲存志願] 按鈕，將當前的志願完整代碼陣列覆寫回 GAS 資料庫的「撕榜前志願表」。
- **PDF 匯出**：系統無最低志願數限制。只要在開放時間內，且最後一次儲存操作成功，即啟用 [匯出 PDF] 按鈕。點擊後呼叫 GAS 生成文件，並於前端提供下載或另開視窗預覽。

### 4.2 志願搜尋與新增頁面 (`add-group`)

此頁面提供學生從已扁平化的專屬清單中，快速篩選並加入心儀校系。

- **搜尋觸發機制**：採用「被動觸發」以節省效能。使用者輸入以空白分隔的多個關鍵字後，必須按下 Enter 鍵或點擊 [搜尋] 按鈕，才啟動過濾邏輯。
- **前端多關鍵字比對**：系統將輸入字串以空白切割為陣列，針對「搜尋文本」欄位執行檢索。必須符合 AND 邏輯（所有關鍵字皆存在於搜尋文本中）才算吻合。
- **智慧權重排序**：過濾後的結果需進行排序。精準命中連續字串（完整符合使用者輸入）的結果優先級最高，排列在前；關鍵字散落命中於不同欄位的結果，優先級較低，排列在後。
- **分頁顯示**：為避免畫面卡頓，搜尋結果採前端分頁渲染，固定每頁顯示 10 筆。底部需配置 Element Plus 分頁導航列。每次執行全新搜尋時，分頁狀態強制重置回第 1 頁。

### 4.3 選填防呆與替換邏輯 (核心規則)

此為本系統最關鍵的業務防護機制，作用於 `add-group` 頁面的 [加入志願] 按鈕。

- **唯一性限制**：同一「學校+學群」組合（透過`學校學群代碼`判斷）只能選填一次，且必須具體指定一個科系。
- **已選狀態顯示**：若畫面上某科系的`完整代碼`已存在於已選志願清單中，該項目的按鈕文字顯示為 [已選取]，且設定為不可點擊的禁用狀態。
- **達上限阻擋**：若學生選擇一個全新的「學校+學群」，且目前志願總數已達 20 個上限，系統需直接攔截，並跳出「志願數已達上限」之錯誤提示。
- **同校學群替換**：若學生選擇的科系，其`完整代碼`未被選過，但其`學校學群代碼`已存在於現有志願清單中，系統需暫停加入動作，並彈出確認對話框告知使用者。
- **替換確認行為**：使用者於對話框點擊同意後，系統「不增加」總志願數，而是直接在 Pinia 陣列中找到舊有的該筆志願，將其科系資料替換為新選項，並維持其原有的志願序位。

---

## 5. GAS 後端 API 介接規格

前端將透過 `google.script.run` 呼叫以下四個主要的 GAS 後端函式。

| **API 名稱**                    | **功能描述與實作要求**                                                  | **回傳格式 / 行為**                             |
| ------------------------------- | ----------------------------------------------------------------------- | ----------------------------------------------- |
| **`getSystemSetup()`**          | 讀取 `setup` 工作表中的設定。主要提供非登入狀態下的時間與狀態查詢需求。 | 回傳包含系統狀態（撕榜前/後）與時間區間的物件。 |
| **`login(username, password)`** | 沿用並擴充既有的 `login.js`。驗證學生學號與密碼。                       | 驗證成功後，於 Payload 中一併打包回傳：         |

1. `setup` 時間設定
2. 該學生專屬 JSON 校系資料
3. 該學生目前的已填志願清單陣列。 |
   | **`saveStudentPreferences(studentId, preferencesArray)`** | 接收前端傳遞的志願代碼陣列（長度至多 20）。於「撕榜前志願表」找到該學生列，並覆寫對應的 20 個志願欄位。 | 回傳執行狀態（成功或失敗訊息），供前端顯示 Toast 提示。 |
   | **`generatePDF(studentId)`** | 觸發原專案 `docBuilder.js` 邏輯。讀取該學生的最新志願，寫入 Google Doc 模板並轉換為 PDF 格式儲存至 Drive。 | 回傳產出之 PDF 檔案的網址 (URL) 供前端開啟。 |
